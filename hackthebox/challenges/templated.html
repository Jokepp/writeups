<link rel="stylesheet" type="text/css" href="includes/style.css">

<h1>Writeup "Templated"</h1>

<h2>Quick Info</h2>

<table>
	<tr><td><b>site</b></td><td>Hack the Box</td></tr>
	<tr><td><b>url</b></td><td><a href="https://app.hackthebox.com/challenges/templated">https://app.hackthebox.com/challenges/templated</a></td></tr>
	<tr><td><b>discussion</b></td><td><a href="https://forum.hackthebox.com/t/official-templated-discussion">https://forum.hackthebox.com/t/official-templated-discussion</a></td></tr>
	<tr><td><b>type</b></td><td>challenge/web</td></tr>
	<tr><td><b>difficulty&nbsp;&nbsp;&nbsp;</b></td><td>easy</td></tr>
	<tr><td><b>startdate</b></td><td>2022-08-08</td></tr>
	<tr><td><b>enddate</b></td><td>2022-08-08</td></tr>
</table>

<h2>Description</h2>

<blockquote>Can you exploit this simple mistake?</blockquote>

<h2>Solution</h2>

<p>We receive an IP and port to a server. When we access the server using a web browser, we see an 'under construction' site. The technology used is displayed (Flask/Jinja2), but no other infos can be found on this site:</p>

<img src="includes/templated-01.png" />

<p>A web search for <i>"flask jinja2 vulnerability"</i> points us in the right direction: under the right conditions, a Server Side Template Injection (SSTI) is possible. Often, this is done by changing the value passed to a HTTP GET parameter. In this case we cannot identify such parameters.</p>

<p>We decide to scan for additional files and folders using <i>gobuster</i>. However, we discover quickly that the server returns a status code <code>200</code> even for all pages, even for pages that do not exist. This makes it impossible to use <i>gobuster</i> in this situation.</p>

<p> While investigating this behaviour, we notice that the error page contains the name of the page we tried to open. The usage of the non-standard <code>&lt;str&gt;</code> tag and the newlines around the name make us think that this string was included by the Flask/Jinja2 template:</p>

<img src="includes/templated-02.png" />

<p>We decide to test whether an SSTI is possible by inserting the following Jinja2 placeholder:</p>

<pre>
{{ 42+5 }}
</pre>

<p>The response is promising:</p>

<img src="includes/templated-03.png" />

<p>We decide to follow the article found earlier and start navigating the chain of Python objects starting with an empty string:</p>

<pre>
{{ ''.__class__ }}
</pre>

<p>This is working and we continue following the chain of objects. The only difficult part is finding out the correct index of the class <code>_io._IOBase</code> (it is 101). Finally, we find the <code>_io.FileIO</code> class using the string:</p>

<pre>
{{ ''.__class__.__base__.__subclasses__()[101].__subclasses__()[0].__subclasses__()[0] }}
</pre>

<img src="includes/templated-04.png" />

<p>We can now use this string like the Python class <code>io.FileIO</code> described under [2]. Calling this class with a file path returns a <code>io.BufferedReader</code> object. Calling its <code>read()</code> method returns the file's contents:</p>

<pre>
{{ ''.__class__.__base__.__subclasses__()[101].__subclasses__()[0].__subclasses__()[0]('flag.txt').read() }}
</pre>

<img src="includes/templated-05.png" />

<p>This gives us the flag:</p>

<pre>
HTB{t3mpl4t3s_4r3_m0r3_p0w3rfu1_th4n_u_th1nk!}
</pre>

<h2>Sources</h2>

<ol id="sources">
	<li><a href="https://kleiber.me/blog/2021/10/31/python-flask-jinja2-ssti-example/">https://kleiber.me/blog/2021/10/31/python-flask-jinja2-ssti-example/</a></li>
	<li><a href="https://docs.python.org/3/library/io.html">https://docs.python.org/3/library/io.html</a></li>
</ol>